
# =======================================
# 2. Auto-discover new microservices
# =======================================
filebeat.autodiscover:
  providers:
    - type: docker
      hints.enabled: true
      labels.dedot: true

      templates:
        # Apply to ALL microservices
        - condition.contains:
            docker.container.labels.service: ""
          config:
            - type: container
              paths:
                - /var/lib/docker/containers/{{data.docker.container.id}}/*.log
              processors:
                - add_docker_metadata: ~
                - decode_json_fields:
                    fields: ["message"]
                    target: ""
                    overwrite_keys: true


# ====================================================
# 3. Processors (apply to ALL log events globally)
# ====================================================
processors:
  - add_locale: ~
  - add_cloud_metadata: ~
  - add_tags:
      tags: ["microservices", "docker"]

  # Drop useless logs (example)
  - drop_event:
      when:
        contains:
          message: "health-check"


# ===================================================
# 4. Output to Elasticsearch
# ===================================================
output.elasticsearch:
  hosts: ["http://elasticsearch:9200"]

  # Optional: index per microservice
  index: "logs-%{[docker.container.name]}-%{+yyyy.MM.dd}"

  worker: 2
  bulk_max_size: 2048
  compression_level: 3


# ===================================================
# 5. Setup Kibana
# ===================================================
setup.kibana:
  host: "http://kibana:5601"

setup.template.enabled: true
setup.template.overwrite: true


# ===================================================
# 7. Registry (stores log offsets)
# ===================================================
filebeat.registry.path: /usr/share/filebeat/data/registry
